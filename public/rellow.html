<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJ RELLOW | SECURE ACCESS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>

    <style>
        body { margin: 0; overflow-x: hidden; background: #000000; font-family: 'Archivo Black', sans-serif; user-select: none; }
        canvas { position: fixed; top: 0; left: 0; z-index: -1; }
        
        .scroll-container { height: 1000vh; position: relative; z-index: 10; }

        /* TEXT STYLING */
        .story-text {
            position: absolute; width: 100%; text-align: center;
            color: transparent; 
            -webkit-text-stroke: 2px rgba(255, 255, 255, 0.3);
            text-transform: uppercase; 
            font-size: clamp(3rem, 10vw, 8rem);
            line-height: 0.9;
            opacity: 0; pointer-events: none;
            mix-blend-mode: overlay;
        }
        
        #chapter-1 { top: 10vh; }
        #chapter-3 { top: 900vh; color: #ffbb00; text-shadow: 0 0 60px rgba(255, 100, 0, 1); }

        /* --- AUDIO OVERLAY --- */
        #audio-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            /* CHANGED: Visible by default now */
            display: flex; 
            justify-content: center; align-items: center; flex-direction: column; gap: 20px;
            cursor: pointer; transition: opacity 0.5s;
        }
        #audio-btn {
            border: 2px solid #F0FF00; color: #F0FF00; padding: 20px 40px;
            font-size: 1.5rem; text-transform: uppercase; background: transparent;
            font-family: 'Archivo Black', sans-serif; letter-spacing: 2px;
            box-shadow: 0 0 30px #F0FF00; animation: pulse 2s infinite;
        }
        .warning { color: white; font-family: Arial; font-size: 0.8rem; opacity: 0.7; }
        @keyframes pulse { 0% { box-shadow: 0 0 20px #F0FF00; } 50% { box-shadow: 0 0 50px #F0FF00; } 100% { box-shadow: 0 0 20px #F0FF00; } }

        /* UI ELEMENTS */
        #top-contact {
            position: fixed; top: 30px; left: 30px;
            color: #F0FF00; border: 2px solid #F0FF00;
            padding: 10px 25px; text-decoration: none;
            font-size: 1rem; z-index: 1000;
            transition: 0.3s; backdrop-filter: blur(5px);
            text-transform: uppercase; letter-spacing: 1px;
        }
        #top-contact:hover { background: #F0FF00; color: black; box-shadow: 0 0 20px #F0FF00; }

        #final-cta {
            position: absolute; top: 950vh; 
            left: 50%; transform: translateX(-50%);
            background: #F0FF00; color: black;
            padding: 20px 50px; text-decoration: none;
            font-size: 1.5rem; white-space: nowrap;
            opacity: 0; 
            box-shadow: 0 0 50px rgba(240, 255, 0, 0.8);
            border-radius: 5px; cursor: pointer;
        }
        #final-cta:hover { transform: translateX(-50%) scale(1.1); }

        /* FADER UI */
        #fader-container {
            position: fixed; top: 50%; right: 40px; transform: translateY(-50%);
            width: 60px; height: 300px; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #fader-track {
            position: relative; width: 6px; height: 100%;
            background: #111; border: 1px solid #333;
            border-radius: 4px; box-shadow: inset 0 0 5px #000;
        }
        .tick { position: absolute; left: -15px; width: 10px; height: 2px; background: #555; }
        .tick.major { width: 20px; left: -25px; background: #888; }
        #fader-knob {
            position: absolute; left: 50%; top: 20%; 
            transform: translate(-50%, -50%);
            width: 40px; height: 60px;
            background: linear-gradient(to right, #222, #444, #222);
            border-radius: 2px; box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            cursor: grab;
        }
        #fader-knob:active { cursor: grabbing; background: linear-gradient(to right, #333, #555, #333); }
        #fader-knob::after {
            content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px;
            background: #fff; box-shadow: 0 0 5px white; transform: translateY(-50%);
        }
        #fader-label {
            color: #F0FF00; font-family: Arial; font-size: 0.7rem; 
            letter-spacing: 2px; margin-top: 15px; text-transform: uppercase;
            text-orientation: sideways; writing-mode: vertical-rl; transform: rotate(180deg);
        }

        /* CONTROLS */
        #controls {
            position: fixed; bottom: 40px; left: 40px;
            z-index: 100; display: flex; flex-direction: column; gap: 10px; align-items: flex-start;
        }
        #upload-btn-label {
            background: rgba(255,255,255,0.1); color: white; padding: 15px 30px;
            border: 1px solid white; font-size: 0.8rem; cursor: pointer; border-radius: 50px;
            transition: transform 0.2s; text-transform: uppercase;
        }
        #upload-btn-label:hover { background: white; color: black; }
        #file-input { display: none; }
        #status { color: white; font-family: 'Arial'; font-size: 0.7rem; opacity: 0.5; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>

    <div id="audio-overlay">
        <button id="audio-btn">DROP THE BEAT</button>
        <div class="warning">STYLE:AFRO HOUSE</div>
    </div>

    <a href="tel:+918819091000" id="top-contact">BOOK NOW</a>

    <div id="fader-container">
        <div id="fader-track">
            <div class="tick major" style="top: 0%"></div>
            <div class="tick" style="top: 10%"></div>
            <div class="tick" style="top: 20%"></div>
            <div class="tick" style="top: 30%"></div>
            <div class="tick" style="top: 40%"></div>
            <div class="tick major" style="top: 50%"></div>
            <div class="tick" style="top: 60%"></div>
            <div class="tick" style="top: 70%"></div>
            <div class="tick" style="top: 80%"></div>
            <div class="tick" style="top: 90%"></div>
            <div class="tick major" style="top: 100%"></div>
            <div id="fader-knob"></div>
        </div>
        <div id="fader-label">MASTER</div>
    </div>

    <div id="controls">
        <div id="status">LIVE: DEEP AFRO HOUSE</div>
        <label id="upload-btn-label" for="file-input">LOAD TRACK</label>
        <input type="file" id="file-input" accept="audio/*">
    </div>

    <div class="scroll-container">
        <div class="story-text" id="chapter-1">SOLAR<br>JOURNEY</div>
        <div class="story-text filled-text" id="chapter-3">DJ<br>RELLOW</div>
        <a href="tel:+918819091000" id="final-cta">CONTACT NOW</a>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- AUDIO ENGINE ---
        const audioEngine = {
            ctx: null, masterGain: null, faderGain: null,
            isPlaying: false, nextNoteTime: 0, 
            tempo: 122, 
            lookahead: 25.0, scheduleAheadTime: 0.1, current16thNote: 0,
            
            synthNotes: [
                55.0, 0, 0, 55.0,   
                0, 55.0, 0, 0,
                65.41, 0, 0, 65.41, 
                0, 55.0, 0, 82.41   
            ],

            noiseNode: null, noiseFilter: null, noiseGain: null,

            init: function() {
                if(this.ctx) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                this.masterGain = this.ctx.createGain();
                this.faderGain = this.ctx.createGain();
                this.faderGain.gain.value = 0.8; 
                this.faderGain.connect(this.masterGain);
                this.masterGain.connect(this.ctx.destination);
                
                this.setupDrone();
                this.isPlaying = true;
                this.nextNoteTime = this.ctx.currentTime;
                this.scheduler();

                document.getElementById('audio-overlay').style.opacity = 0;
                setTimeout(() => document.getElementById('audio-overlay').remove(), 500);
            },

            setFaderLevel: function(level) {
                if(this.faderGain) {
                    const val = Math.max(0.001, level);
                    this.faderGain.gain.setTargetAtTime(val * val, this.ctx.currentTime, 0.05);
                }
            },

            setupDrone: function() {
                const bufferSize = 2 * this.ctx.sampleRate;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const output = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) output[i] = (Math.random() * 2 - 1) * 0.5;
                
                this.noiseNode = this.ctx.createBufferSource();
                this.noiseNode.buffer = buffer;
                this.noiseNode.loop = true;
                this.noiseFilter = this.ctx.createBiquadFilter();
                this.noiseFilter.type = 'lowpass';
                this.noiseFilter.frequency.value = 60; 
                this.noiseGain = this.ctx.createGain();
                this.noiseGain.gain.value = 0;
                
                this.noiseNode.connect(this.noiseFilter);
                this.noiseFilter.connect(this.noiseGain);
                this.noiseGain.connect(this.faderGain);
                this.noiseNode.start(0);
            },

            updateDrone: function(speed, intensity) {
                if(!this.ctx) return;
                const freq = 60 + (speed * 400) + (intensity * 150);
                const vol = (speed * 0.5) + (intensity * 0.2);
                this.noiseFilter.frequency.setTargetAtTime(freq, this.ctx.currentTime, 0.1);
                this.noiseGain.gain.setTargetAtTime(vol, this.ctx.currentTime, 0.1);
            },

            scheduler: function() {
                while (this.nextNoteTime < this.ctx.currentTime + this.scheduleAheadTime) {
                    this.scheduleNote(this.current16thNote, this.nextNoteTime);
                    this.nextNote();
                }
                if(this.isPlaying) window.setTimeout(() => this.scheduler(), this.lookahead);
            },

            nextNote: function() {
                const secondsPerBeat = 60.0 / this.tempo;
                this.nextNoteTime += 0.25 * secondsPerBeat;
                this.current16thNote++;
                if (this.current16thNote == 16) this.current16thNote = 0;
            },

            scheduleNote: function(beat, time) {
                if (beat % 4 === 0) this.playKick(time);
                if (beat % 4 === 2) this.playOpenHat(time);
                this.playShaker(time, beat % 2 === 0 ? 0.04 : 0.09);
                if (beat === 3 || beat === 6 || beat === 12) this.playWoodblock(time);
                if (beat === 2 || beat === 6 || beat === 10 || beat === 14) this.playSubBass(time, 43.65);
                const note = this.synthNotes[beat];
                if(note > 0) this.playPluck(time, note);
            },

            playKick: function(time) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.faderGain);
                osc.frequency.setValueAtTime(120, time);
                osc.frequency.exponentialRampToValueAtTime(50, time + 0.15);
                gain.gain.setValueAtTime(1.0, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
                osc.start(time); osc.stop(time + 0.2);
            },

            playOpenHat: function(time) {
                const bufferSize = this.ctx.sampleRate * 0.2; 
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
                const filter = this.ctx.createBiquadFilter(); filter.type = 'highpass'; filter.frequency.value = 6000;
                const gain = this.ctx.createGain();
                noise.connect(filter); filter.connect(gain); gain.connect(this.faderGain);
                gain.gain.setValueAtTime(0.3, time); 
                gain.gain.exponentialRampToValueAtTime(0.01, time + 0.15);
                noise.start(time);
            },

            playShaker: function(time, vol) {
                 const bufferSize = this.ctx.sampleRate * 0.05; 
                 const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                 const data = buffer.getChannelData(0);
                 for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                 const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
                 const gain = this.ctx.createGain();
                 noise.connect(gain); gain.connect(this.faderGain);
                 gain.gain.setValueAtTime(vol, time); gain.gain.exponentialRampToValueAtTime(0.01, time + 0.04);
                 noise.start(time);
            },

            playWoodblock: function(time) {
                const osc = this.ctx.createOscillator(); osc.type = 'triangle';
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.faderGain);
                osc.frequency.setValueAtTime(800, time);
                gain.gain.setValueAtTime(0.15, time); gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
                osc.start(time); osc.stop(time + 0.05);
            },

            playSubBass: function(time, freq) {
                const osc = this.ctx.createOscillator(); osc.type = 'sine';
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.faderGain);
                osc.frequency.setValueAtTime(freq, time);
                gain.gain.setValueAtTime(0.6, time); gain.gain.linearRampToValueAtTime(0.4, time + 0.1); gain.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
                osc.start(time); osc.stop(time + 0.3);
            },
            
            playPluck: function(time, freq) {
                const osc = this.ctx.createOscillator(); osc.type = 'sawtooth';
                const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass';
                const gain = this.ctx.createGain();
                osc.connect(filter); filter.connect(gain); gain.connect(this.faderGain);
                osc.frequency.setValueAtTime(freq, time);
                filter.frequency.setValueAtTime(200, time); filter.frequency.exponentialRampToValueAtTime(2000, time + 0.05); filter.frequency.exponentialRampToValueAtTime(200, time + 0.4);
                gain.gain.setValueAtTime(0.05, time); gain.gain.exponentialRampToValueAtTime(0.01, time + 0.4);
                osc.start(time); osc.stop(time + 0.4);
            }
        };

        // --- AUTO SCROLL TRIGGER ---
        document.getElementById('audio-overlay').addEventListener('click', () => {
            audioEngine.init();
            
            gsap.registerPlugin(ScrollToPlugin);
            const maxScroll = document.documentElement.scrollHeight - window.innerHeight;

            gsap.to(window, {
                scrollTo: maxScroll,
                duration: 15, 
                ease: "none"
            });
        });

        // --- FADER DRAG LOGIC ---
        const faderTrack = document.getElementById('fader-track');
        const faderKnob = document.getElementById('fader-knob');
        let isDragging = false;

        faderKnob.addEventListener('mousedown', (e) => { isDragging = true; e.preventDefault(); });
        document.addEventListener('mouseup', () => { isDragging = false; });
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const rect = faderTrack.getBoundingClientRect();
            let y = e.clientY - rect.top;
            y = Math.max(0, Math.min(y, rect.height));
            faderKnob.style.top = y + 'px';
            const percent = 1 - (y / rect.height);
            audioEngine.setFaderLevel(percent);
        });
        faderKnob.addEventListener('touchstart', (e) => { isDragging = true; e.preventDefault(); });
        document.addEventListener('touchend', () => { isDragging = false; });
        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const rect = faderTrack.getBoundingClientRect();
            let y = e.touches[0].clientY - rect.top;
            y = Math.max(0, Math.min(y, rect.height));
            faderKnob.style.top = y + 'px';
            const percent = 1 - (y / rect.height);
            audioEngine.setFaderLevel(percent);
        });


        // --- THREE.JS SCENE ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.001); 
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.body.appendChild(renderer.domElement);
        camera.position.z = 320; camera.position.y = 50;

        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.15; bloomPass.strength = 1.5; bloomPass.radius = 0.5;
        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene); composer.addPass(bloomPass);

        const ambientLight = new THREE.AmbientLight(0x404040, 2); scene.add(ambientLight);
        const sunLight = new THREE.PointLight(0xffaa00, 4, 800); scene.add(sunLight);
        const camLight = new THREE.DirectionalLight(0xffffff, 0.5); 
        camLight.position.set(0,0,1); camera.add(camLight); scene.add(camera);

        // --- PROCEDURAL TEXTURES ---
        function createPlanetTexture(type, color1Hex, color2Hex) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            const color1 = new THREE.Color(color1Hex).getStyle();
            const color2 = new THREE.Color(color2Hex).getStyle();
            ctx.fillStyle = color1; ctx.fillRect(0,0,512,512);
            if(type === 'gas') {
                for(let i=0; i<20; i++) {
                    ctx.fillStyle = Math.random() > 0.5 ? color2 : color1;
                    ctx.globalAlpha = 0.3 + Math.random() * 0.3;
                    ctx.fillRect(0, Math.random()*512, 512, Math.random()*50);
                }
            } else {
                for(let i=0; i<200; i++) {
                    ctx.beginPath(); ctx.arc(Math.random()*512, Math.random()*512, Math.random()*10, 0, Math.PI*2);
                    ctx.fillStyle = color2; ctx.globalAlpha = 0.4; ctx.fill();
                }
            }
            return new THREE.CanvasTexture(canvas);
        }

        // --- SCENE OBJECTS ---
        const sunMat = new THREE.ShaderMaterial({
            uniforms: { time: { value: 0 }, beatScale: { value: 1.0 }, distortion: { value: 1.5 }, opacity: { value: 1.0 }, brightness: { value: 0.0 } },
            vertexShader: `uniform float time;uniform float beatScale;uniform float distortion;varying vec2 vUv;varying float vNoise;varying vec3 vNormal; vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; } vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; } vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); } vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; } float snoise(vec3 v) { const vec2 C = vec2(1.0/6.0, 1.0/3.0); const vec4 D = vec4(0.0, 0.5, 1.0, 2.0); vec3 i = floor(v + dot(v, C.yyy)); vec3 x0 = v - i + dot(i, C.xxx); vec3 g = step(x0.yzx, x0.xyz); vec3 l = 1.0 - g; vec3 i1 = min(g.xyz, l.zxy); vec3 i2 = max(g.xyz, l.zxy); vec3 x1 = x0 - i1 + C.xxx; vec3 x2 = x0 - i2 + C.yyy; vec3 x3 = x0 - D.yyy; i = mod289(i); vec4 p = permute(permute(permute(i.z + vec4(0.0, i1.z, i2.z, 1.0)) + i.y + vec4(0.0, i1.y, i2.y, 1.0)) + i.x + vec4(0.0, i1.x, i2.x, 1.0)); float n_ = 0.142857142857; vec3 ns = n_ * D.wyz - D.xzx; vec4 j = p - 49.0 * floor(p * ns.z * ns.z); vec4 x_ = floor(j * ns.z); vec4 y_ = floor(j - 7.0 * x_); vec4 x = x_ * ns.x + ns.yyyy; vec4 y = y_ * ns.x + ns.yyyy; vec4 h = 1.0 - abs(x) - abs(y); vec4 b0 = vec4(x.xy, y.xy); vec4 b1 = vec4(x.zw, y.zw); vec4 s0 = floor(b0) * 2.0 + 1.0; vec4 s1 = floor(b1) * 2.0 + 1.0; vec4 sh = -step(h, vec4(0.0)); vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy; vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww; vec3 p0 = vec3(a0.xy, h.x); vec3 p1 = vec3(a0.zw, h.y); vec3 p2 = vec3(a1.xy, h.z); vec3 p3 = vec3(a1.zw, h.w); vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3))); p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w; vec4 m = max(0.6 - vec4(dot(x0, x0), dot(x1, x1), dot(x2, x2), dot(x3, x3)), 0.0); m = m * m; return 42.0 * dot(m * m, vec4(dot(p0, x0), dot(p1, x1), dot(p2, x2), dot(p3, x3))); } void main() { vUv = uv; vNormal = normal; float noiseVal = snoise(position * 0.10 + time * 0.5); vNoise = noiseVal; vec3 newPos = position + (normal * noiseVal * distortion * beatScale); gl_Position = projectionMatrix * modelViewMatrix * vec4(newPos, 1.0); }`,
            fragmentShader: `uniform float time; varying float vNoise; varying vec3 vNormal; uniform float opacity; uniform float brightness; void main() { vec3 c1 = vec3(1.0, 0.05, 0.0); vec3 c2 = vec3(2.0, 0.8, 0.0); vec3 c3 = vec3(4.0, 3.0, 1.0 + brightness); vec3 color = mix(c1, c2, vNoise * 2.0 + 0.2); color = mix(color, c3, vNoise * 4.0); color += vec3(brightness * 2.0); float rim = 1.0 - max(dot(vNormal, vec3(0.0, 0.0, 1.0)), 0.0); color += vec3(2.0, 0.5, 0.0) * pow(rim, 3.0); gl_FragColor = vec4(color, opacity); }`,
            blending: THREE.AdditiveBlending, transparent: true, side: THREE.DoubleSide
        });
        const sun = new THREE.Mesh(new THREE.IcosahedronGeometry(15, 60), sunMat);
        scene.add(sun);

        const planets = [], planetData = [
            { r: 1.5, dist: 35, speed: 0.8, type: 'rock', c1: 0x8c8c8c, c2: 0x555555 },
            { r: 2.5, dist: 50, speed: 0.6, type: 'gas', c1: 0xe6b800, c2: 0xffaa00 },
            { r: 2.8, dist: 70, speed: 0.5, type: 'rock', c1: 0x0044ff, c2: 0x008800 },
            { r: 1.8, dist: 90, speed: 0.45, type: 'rock', c1: 0xff3300, c2: 0x881100 },
            { r: 8.0, dist: 130, speed: 0.2, type: 'gas', c1: 0xd9a66c, c2: 0x8c6239 },
            { r: 7.0, dist: 170, speed: 0.15, type: 'gas', c1: 0xe6c366, c2: 0x997722, hasRing: true },
            { r: 5.0, dist: 210, speed: 0.1, type: 'gas', c1: 0x66ccff, c2: 0x0088ff, hasRing: true },
            { r: 4.8, dist: 240, speed: 0.08, type: 'gas', c1: 0x3333ff, c2: 0x111199 }
        ];

        planetData.forEach(d => {
            const grp = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ map: createPlanetTexture(d.type, d.c1, d.c2), roughness: 0.7, metalness: 0.1, emissive: d.c1, emissiveIntensity: 0.1 });
            const mesh = new THREE.Mesh(new THREE.SphereGeometry(d.r, 64, 64), mat);
            mesh.position.x = d.dist; grp.add(mesh);
            if(d.hasRing) {
                const ring = new THREE.Mesh(new THREE.RingGeometry(d.r+2, d.r+6, 64), new THREE.MeshBasicMaterial({ color: d.c1, transparent: true, opacity: 0.4, side: THREE.DoubleSide }));
                ring.rotation.x = Math.PI/2+0.3; ring.position.x = d.dist; grp.add(ring);
            }
            grp.userData = { d: d.dist, s: d.speed, a: Math.random()*Math.PI*2 };
            scene.add(grp); planets.push(grp);
        });

        const asteroids = new THREE.InstancedMesh(new THREE.DodecahedronGeometry(0.4,0), new THREE.MeshStandardMaterial({color:0x666666}), 1500);
        const dummy = new THREE.Object3D();
        for(let i=0; i<1500; i++) {
            const a = Math.random()*Math.PI*2, r = 105+Math.random()*15, y=(Math.random()-0.5)*8;
            dummy.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
            dummy.rotation.set(Math.random(), Math.random(), Math.random());
            dummy.scale.setScalar(0.5+Math.random());
            dummy.updateMatrix(); asteroids.setMatrixAt(i, dummy.matrix);
        }
        scene.add(asteroids);

        const starsPos = new Float32Array(9000);
        for(let i=0; i<9000; i++) starsPos[i] = (Math.random()-0.5)*1500;
        const starGeo = new THREE.BufferGeometry();
        starGeo.setAttribute('position', new THREE.BufferAttribute(starsPos, 3));
        const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color:0xffffff, size:0.6}));
        scene.add(stars);

        let morphParticles = null, morphTarget = {p:0};
        const loader = new FontLoader();
        loader.load('https://unpkg.com/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json', font => {
            const tGeo = new TextGeometry('DJ RELLOW', {font:font, size:8, height:0.8});
            tGeo.center(); tGeo.computeBoundingBox();
            const min=tGeo.boundingBox.min.y, range=tGeo.boundingBox.max.y-min;
            const count = tGeo.attributes.position.count, end = tGeo.attributes.position.array;
            const start = new Float32Array(count*3), colors = new Float32Array(count*3);
            const cB = new THREE.Color(0xff0000), cT = new THREE.Color(0xffff00), cW = new THREE.Color();
            for(let i=0; i<count; i++) {
                const i3=i*3; start[i3]=0; start[i3+1]=0; start[i3+2]=0;
                const alpha = (end[i3+1]-min)/range;
                cW.lerpColors(cB, cT, alpha);
                colors[i3]=cW.r*2; colors[i3+1]=cW.g*2; colors[i3+2]=cW.b*2;
            }
            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.BufferAttribute(start, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            morphParticles = new THREE.Points(geo, new THREE.PointsMaterial({vertexColors:true, size:0.35, blending:THREE.AdditiveBlending}));
            morphParticles.userData = {s:start, e:end}; morphParticles.visible=false; scene.add(morphParticles);
            initTimeline();
        });

        // --- ANIMATION LOOP ---
        gsap.registerPlugin(ScrollTrigger);
        let scrollVelocity = 0;
        
        function initTimeline() {
            // FIX: Create a target color object
            const targetFogColor = new THREE.Color(0xffaa00);

            const tl = gsap.timeline({ scrollTrigger: { 
                trigger: ".scroll-container", start: "top top", end: "bottom bottom", scrub: 0.5,
                onUpdate: (self) => { scrollVelocity = Math.abs(self.getVelocity()); }
            }});

            tl.to(camera.position, { z: 2, y: 0, duration: 10, ease: "none" }, 0);
            tl.to(sunMat.uniforms.distortion, { value: 10.0, duration: 8.5, ease: "power2.in" }, 0)
              .to(sunMat.uniforms.brightness, { value: 0.5, duration: 8.5, ease: "power2.in" }, 0)
              .to("#chapter-1", { opacity: 1, duration: 1, yoyo: true, repeat: 1 }, 0)
              
              // FIX: Animate properties individually instead of replacing the object
              .to(scene.fog, { density: 0.05, duration: 1.5 }, 8.5)
              .to(scene.fog.color, { r: targetFogColor.r, g: targetFogColor.g, b: targetFogColor.b, duration: 1.5 }, 8.5)

              .to(sunMat.uniforms.brightness, { value: 5.0, duration: 1.5 }, 8.5)
              .to(sunMat.uniforms.opacity, { value: 0, duration: 0.2 }, 9.5)
              .call(() => { morphParticles.visible = true; scene.fog.density = 0.002; scene.fog.color.setHex(0x000000); }, null, 9.5)
              .to(morphParticles.material, { size: 0.5, duration: 0.5 }, 9.5)
              .to(morphTarget, { p: 1, duration: 0.5, ease: "power2.out" }, 9.5)
              .to("#chapter-3", { opacity: 1, duration: 0.5 }, 9.8)
              .to("#final-cta", { opacity: 1, y: -20, duration: 0.5 }, 9.8);
        }

        let mouseX=0, mouseY=0;
        document.addEventListener('mousemove', e => {
            mouseX = (e.clientX-window.innerWidth/2)*0.02; mouseY=(e.clientY-window.innerHeight/2)*0.02;
        });

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            sunMat.uniforms.time.value = time; sun.rotation.y = time*0.05; asteroids.rotation.y = time*0.01;
            camera.position.x += (mouseX-camera.position.x)*0.05; camera.position.y += (mouseY-camera.position.y)*0.05; camera.lookAt(0,0,0);
            
            planets.forEach(p => {
                p.userData.a += p.userData.s*0.005;
                p.position.x = Math.cos(p.userData.a)*p.userData.d; p.position.z = Math.sin(p.userData.a)*p.userData.d; p.rotation.y += 0.01;
            });

            if(morphParticles && morphParticles.visible) {
                const p = morphParticles.geometry.attributes.position.array, s = morphParticles.userData.s, e = morphParticles.userData.e;
                for(let i=0; i<p.length; i++) p[i] = s[i] + (e[i]-s[i]) * morphTarget.p;
                morphParticles.geometry.attributes.position.needsUpdate = true;
            }
            
            const progress = (320 - camera.position.z) / 320; 
            const velocity = Math.min(scrollVelocity / 5000, 1); 
            audioEngine.updateDrone(velocity, Math.max(0, progress));

            composer.render();
        }
        animate();
        window.onresize = () => { 
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth,window.innerHeight); composer.setSize(window.innerWidth,window.innerHeight);
        };
    </script>
</body>
</html>
